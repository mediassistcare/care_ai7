{% extends "base.html" %}

{% block title %}ICD11 Code Generation - Step 7 - Care Diagnostics{% endblock %}

{% block content %}
<div class="step-container">
    <div class="step-header">
        <h2><i class="fas fa-code-branch"></i> Step 7: ICD11 Code Generation and Analysis</h2>
        <p>Generate standardized ICD11 medical codes based on your comprehensive clinical assessment</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: 100%"></div>
        </div>
    </div>

    <div class="icd-container">
        <!-- Clinical Summary Section -->
        <div class="clinical-summary-section">
            <h3><i class="fas fa-file-medical-alt"></i> Clinical Summary</h3>
            <p class="section-description">Review and edit the clinical summary before generating ICD11 codes</p>
            
            <div class="summary-input-container">
                <label for="clinical-summary-text" class="form-label">Clinical Summary:</label>
                <div class="formatting-status" id="formatting-status" style="display: none;">
                    <i class="fas fa-magic"></i> 
                    <span>Clinical summary has been automatically formatted for better readability</span>
                </div>
                <textarea 
                    id="clinical-summary-text" 
                    name="clinical-summary-text" 
                    class="form-control clinical-summary-textarea"
                    rows="12"
                    placeholder="Loading clinical summary from previous step..."
                    readonly>
                </textarea>
                <div class="summary-actions">
                    <button type="button" class="btn-secondary" id="edit-summary-btn" onclick="toggleSummaryEdit()">
                        <i class="fas fa-edit"></i> Edit Summary
                    </button>
                    <button type="button" class="btn-secondary" id="reformat-btn" onclick="reformatSummary()">
                        <i class="fas fa-magic"></i> Format Text (Optional)
                    </button>
                    <button type="button" class="btn-secondary" id="save-summary-btn" onclick="saveSummaryChanges()" style="display: none;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn-secondary" id="cancel-edit-btn" onclick="cancelSummaryEdit()" style="display: none;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="step-actions">
            <button type="button" class="btn-secondary" onclick="window.location.href='/step6'">
                <i class="fas fa-arrow-left"></i> Back to Step 6
            </button>
            <button type="button" class="btn-primary" id="generate-icd-btn" onclick="generateICD11Codes()">
                Generate ICD11 Codes <i class="fas fa-code"></i>
            </button>
        </div>

        <!-- ICD Results will be dynamically inserted here -->
        
        <!-- Final Completion Section -->
        <div class="completion-section" id="completion-section" style="display: none;">
            <div class="completion-card">
                <div class="completion-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Assessment Complete!</h3>
                <p>Thank you for using the AI-powered medical assessment system. Your data has been saved securely.</p>
                
                <div class="completion-actions">
                    <button type="button" class="btn-secondary" onclick="downloadReport()">
                        <i class="fas fa-download"></i> Download Report
                    </button>
                    <button type="button" class="btn-primary" onclick="startNewAssessment()">
                        <i class="fas fa-plus"></i> Start New Assessment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Dialog Modal -->
<div class="feedback-modal" id="feedback-modal" style="display: none;">
    <div class="modal-overlay" onclick="closeFeedbackDialog()"></div>
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3><i class="fas fa-comment-alt"></i> Your Feedback</h3>
            <button class="modal-close" onclick="closeFeedbackDialog()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Please share your thoughts about the AI-powered medical assessment:</p>
            <textarea 
                id="feedback-text" 
                placeholder="Share your experience, suggestions for improvement, or any issues you encountered..."
                rows="6"
                class="feedback-textarea">
            </textarea>
            
            <!-- Multiple Image Upload Section -->
            <div class="image-upload-section">
                <label class="form-label">
                    <i class="fas fa-images"></i> Attach Images (Optional)
                </label>
                <p class="upload-description">You can upload multiple images to support your feedback (medical reports, screenshots, etc.)</p>
                
                <div class="image-upload-container">
                    <input 
                        type="file" 
                        id="feedback-images" 
                        name="feedback-images"
                        accept="image/*"
                        multiple
                        style="display: none;"
                        onchange="handleImageSelection(this)"
                    />
                    <label for="feedback-images" class="upload-button">
                        <i class="fas fa-cloud-upload-alt"></i> Select Images
                    </label>
                    <span class="upload-info">Supported formats: JPG, PNG, GIF | Max size per image: 10MB</span>
                </div>
                
                <!-- Image Preview Container -->
                <div class="image-preview-container" id="image-preview-container" style="display: none;">
                    <h4><i class="fas fa-eye"></i> Selected Images:</h4>
                    <div class="image-previews" id="image-previews"></div>
                    <div class="image-actions">
                        <button type="button" class="btn-secondary small" onclick="clearImages()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                        <span class="image-count" id="image-count">0 images selected</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeFeedbackDialog()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" class="btn-primary" onclick="saveFeedback()">
                <i class="fas fa-save"></i> Save Feedback
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let originalSummary = '';
let currentSummary = '';

document.addEventListener('DOMContentLoaded', function() {
    // Load clinical summary from step 6
    loadClinicalSummary();
});

function loadClinicalSummary() {
    console.log('Loading clinical summary from step 6...');
    
    fetch('/get_clinical_summary', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.clinical_summary) {
            originalSummary = data.clinical_summary;
            
            // Show loading state for automatic formatting
            const textarea = document.getElementById('clinical-summary-text');
            textarea.value = 'Loading and formatting clinical summary...';
            textarea.setAttribute('readonly', 'readonly');
            
            // Automatically format the clinical summary with LLM when it loads
            formatClinicalSummaryWithLLM(data.clinical_summary)
                .then(formattedSummary => {
                    currentSummary = formattedSummary;
                    
                    textarea.value = formattedSummary;
                    textarea.removeAttribute('readonly');
                    
                    // Show formatting status message
                    const formatStatus = document.getElementById('formatting-status');
                    formatStatus.style.display = 'flex';
                    
                    console.log('Clinical summary loaded and auto-formatted with LLM:', formattedSummary.length, 'characters');
                })
                .catch(error => {
                    console.error('Auto-formatting failed, using original text:', error);
                    // Fallback to original text if formatting fails
                    currentSummary = data.clinical_summary;
                    
                    textarea.value = data.clinical_summary;
                    textarea.removeAttribute('readonly');
                    
                    const formatStatus = document.getElementById('formatting-status');
                    formatStatus.style.display = 'flex';
                    
                    // Show a subtle message that formatting wasn't applied
                    setTimeout(() => {
                        showError('Auto-formatting unavailable. You can use the "Format Text" button to format manually.', 5000);
                    }, 1000);
                });
        } else {
            console.error('Failed to load clinical summary:', data.error);
            const textarea = document.getElementById('clinical-summary-text');
            textarea.value = 'No clinical summary available. Please complete the previous steps first.';
            textarea.setAttribute('readonly', 'readonly');
            
            // Show error message
            showError(data.error || 'Failed to load clinical summary from previous step');
        }
    })
    .catch(error => {
        console.error('Error loading clinical summary:', error);
        const textarea = document.getElementById('clinical-summary-text');
        textarea.value = 'Error loading clinical summary: ' + error.message;
        textarea.setAttribute('readonly', 'readonly');
        
        showError('Network error: ' + error.message);
    });
}

async function formatClinicalSummaryWithLLM(rawSummary) {
    if (!rawSummary || typeof rawSummary !== 'string') {
        return rawSummary;
    }
    
    try {
        const response = await fetch('/format_clinical_summary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: rawSummary
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.formatted_text) {
            return data.formatted_text;
        } else {
            throw new Error(data.error || 'Failed to format text with LLM');
        }
    } catch (error) {
        console.error('LLM formatting error:', error);
        throw error;
    }
}

function formatClinicalSummaryBasic(rawSummary) {
    if (!rawSummary || typeof rawSummary !== 'string') {
        return rawSummary;
    }
    
    let formatted = rawSummary;
    
    // Step 1: Clean up multiple consecutive line breaks and spaces
    formatted = formatted.replace(/\n\s*\n\s*\n/g, '\n\n'); // Reduce multiple line breaks to double
    formatted = formatted.replace(/[ \t]+/g, ' '); // Replace multiple spaces with single space
    formatted = formatted.trim(); // Remove leading/trailing whitespace
    
    // Step 2: Add proper spacing after section headers (text followed by a colon)
    formatted = formatted.replace(/([A-Za-z\s]+:)(?!\n)/g, '$1\n');
    
    // Step 3: Add line breaks before bullet points and numbered lists
    formatted = formatted.replace(/(?<!\n)(\s*[-•*]\s*)/g, '\n$1');
    formatted = formatted.replace(/(?<!\n)(\s*\d+\.\s*)/g, '\n$1');
    
    // Step 4: Add proper spacing for common medical section headers
    const sectionHeaders = [
        'CHIEF COMPLAINT',
        'HISTORY OF PRESENT ILLNESS',
        'PAST MEDICAL HISTORY',
        'MEDICATIONS',
        'ALLERGIES',
        'SOCIAL HISTORY',
        'FAMILY HISTORY',
        'REVIEW OF SYSTEMS',
        'PHYSICAL EXAMINATION',
        'VITAL SIGNS',
        'ASSESSMENT',
        'PLAN',
        'CLINICAL IMPRESSION',
        'DIFFERENTIAL DIAGNOSIS',
        'RECOMMENDATIONS',
        'FOLLOW-UP',
        'Patient Information',
        'Vital Signs',
        'Medical History',
        'Current Medications',
        'Symptoms and Complaints',
        'Analysis and Assessment',
        'Clinical Findings',
        'Diagnostic Considerations'
    ];
    
    sectionHeaders.forEach(header => {
        // Add double line break before section headers (if not already at start of line)
        const headerRegex = new RegExp(`(?<!^|\\n\\n)(?=\\b${header.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b)`, 'gmi');
        formatted = formatted.replace(headerRegex, '\n\n');
        
        // Ensure section headers are properly capitalized and have consistent formatting
        const headerRegexExact = new RegExp(`\\b${header.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gmi');
        formatted = formatted.replace(headerRegexExact, header.toUpperCase());
    });
    
    // Step 5: Format medical data in a structured way
    formatted = formatted.replace(/(\w+):\s*([^\n]+)/g, (match, label, value) => {
        // Format key-value pairs with consistent spacing
        return `${label.toUpperCase()}: ${value.trim()}`;
    });
    
    // Step 6: Clean up any excessive line breaks that might have been created
    formatted = formatted.replace(/\n\n\n+/g, '\n\n'); // Reduce triple+ line breaks to double
    formatted = formatted.replace(/^\n+/, ''); // Remove leading line breaks
    formatted = formatted.replace(/\n+$/, '\n'); // Remove trailing line breaks except one
    
    // Step 7: Add proper indentation for bullet points and sub-items
    const lines = formatted.split('\n');
    const formattedLines = lines.map(line => {
        const trimmedLine = line.trim();
        
        // Handle bullet points
        if (trimmedLine.match(/^[-•*]\s*/)) {
            return '  • ' + trimmedLine.replace(/^[-•*]\s*/, '');
        }
        
        // Handle numbered lists
        if (trimmedLine.match(/^\d+\.\s*/)) {
            return '  ' + trimmedLine;
        }
        
        // Handle sub-bullet points
        if (trimmedLine.match(/^\s+[-•*]\s*/)) {
            return '    • ' + trimmedLine.replace(/^\s*[-•*]\s*/, '');
        }
        
        return line;
    });
    
    return formattedLines.join('\n');
}

function reformatSummary() {
    const textarea = document.getElementById('clinical-summary-text');
    const currentText = textarea.value;
    
    if (!currentText.trim()) {
        showError('No text to format');
        return;
    }
    
    // Show loading state
    const reformatBtn = document.getElementById('reformat-btn');
    const originalHTML = reformatBtn.innerHTML;
    reformatBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Formatting...';
    reformatBtn.disabled = true;
    
    // Apply LLM formatting to current content
    formatClinicalSummaryWithLLM(currentText)
        .then(formattedText => {
            textarea.value = formattedText;
            currentSummary = formattedText;
            
            // Show formatting status
            const formatStatus = document.getElementById('formatting-status');
            formatStatus.style.display = 'flex';
            
            // Show success state
            reformatBtn.innerHTML = '<i class="fas fa-check"></i> Formatted!';
            reformatBtn.style.background = '#27ae60';
            reformatBtn.disabled = false;
            
            setTimeout(() => {
                reformatBtn.innerHTML = originalHTML;
                reformatBtn.style.background = '';
            }, 2000);
        })
        .catch(error => {
            console.error('LLM formatting failed, using fallback:', error);
            
            // Fallback to basic formatting
            const formattedText = formatClinicalSummaryBasic(currentText);
            textarea.value = formattedText;
            currentSummary = formattedText;
            
            // Show warning state
            reformatBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Basic Format';
            reformatBtn.style.background = '#f39c12';
            reformatBtn.disabled = false;
            
            setTimeout(() => {
                reformatBtn.innerHTML = originalHTML;
                reformatBtn.style.background = '';
            }, 3000);
            
            showError('Advanced formatting unavailable. Applied basic formatting.');
        });
}

function toggleSummaryEdit() {
    const textarea = document.getElementById('clinical-summary-text');
    const editBtn = document.getElementById('edit-summary-btn');
    const saveBtn = document.getElementById('save-summary-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    
    // Enable editing
    textarea.removeAttribute('readonly');
    textarea.focus();
    
    // Toggle button visibility
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
    
    // Add editing class for styling
    textarea.classList.add('editing');
}

function saveSummaryChanges() {
    const textarea = document.getElementById('clinical-summary-text');
    const newSummary = textarea.value.trim();
    
    if (!newSummary) {
        alert('Clinical summary cannot be empty');
        return;
    }
    
    console.log('Saving updated clinical summary...');
    
    // Save the updated summary
    fetch('/save_clinical_summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            clinical_summary: newSummary,
            updated_from_step7: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentSummary = newSummary;
            originalSummary = newSummary;
            
            // Disable editing mode
            finishSummaryEdit();
            
            // Show success message
            showSuccess('Clinical summary updated successfully');
            
            console.log('Clinical summary updated successfully');
        } else {
            console.error('Failed to save summary changes:', data.error);
            showError('Failed to save changes: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving summary changes:', error);
        showError('Error saving changes: ' + error.message);
    });
}

function cancelSummaryEdit() {
    const textarea = document.getElementById('clinical-summary-text');
    
    // Restore original summary
    textarea.value = originalSummary;
    
    // Disable editing mode
    finishSummaryEdit();
}

function finishSummaryEdit() {
    const textarea = document.getElementById('clinical-summary-text');
    const editBtn = document.getElementById('edit-summary-btn');
    const saveBtn = document.getElementById('save-summary-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    
    // Disable editing
    textarea.setAttribute('readonly', 'readonly');
    
    // Toggle button visibility
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    
    // Remove editing class
    textarea.classList.remove('editing');
}

function generateICD11Codes() {
    const textarea = document.getElementById('clinical-summary-text');
    const clinicalSummary = textarea.value.trim();
    
    if (!clinicalSummary) {
        showError('Please provide a clinical summary before generating ICD11 codes');
        return;
    }
    
    console.log('Generating ICD11 codes...');
    
    // Check if questions were skipped in step 6
    checkQuestionsSkippedStatus().then(questionsSkipped => {
        if (questionsSkipped) {
            showSkipDisclaimer().then(proceed => {
                if (proceed) {
                    generateICD11CodesActual(clinicalSummary);
                }
            });
        } else {
            generateICD11CodesActual(clinicalSummary);
        }
    }).catch(error => {
        console.log('Could not determine skip status, proceeding normally:', error);
        generateICD11CodesActual(clinicalSummary);
    });
}

function generateICD11CodesActual(clinicalSummary) {
    console.log('Generating ICD11 codes...');
    
    // Reset elimination history for new ICD code generation
    window.eliminationHistory = [];
    console.log('🔄 Reset elimination history for new ICD generation');
    
    const generateBtn = document.getElementById('generate-icd-btn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Codes...';
    
    // Create and show results container if it doesn't exist
    let resultsContainer = document.getElementById('icd-results');
    if (!resultsContainer) {
        resultsContainer = document.createElement('div');
        resultsContainer.id = 'icd-results';
        resultsContainer.className = 'icd-results-section';
        document.querySelector('.icd-container').appendChild(resultsContainer);
    }
    
    // Show loading state
    resultsContainer.innerHTML = `
        <div class="loading-state">
            <div class="loading-spinner">
                <i class="fas fa-cog fa-spin fa-2x"></i>
            </div>
            <h3>Generating ICD-11 codes...</h3>
            <p>Analyzing clinical summary and generating WHO ICD-11 diagnostic codes...</p>
        </div>
    `;
    resultsContainer.style.display = 'block';
    
    // Call ICD generation endpoint
    fetch('/generate_icd_codes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            clinical_summary: clinicalSummary
        })
    })
    .then(response => {
        console.log('ICD response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ICD response data:', data);
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'Generate ICD11 Codes <i class="fas fa-code"></i>';
        
        if (data.success) {
            console.log('ICD11 codes generated successfully:', data);
            displayICD11Results(data.icd_codes, data.analysis_notes);
        } else {
            console.error('Failed to generate ICD11 codes:', data.error);
            resultsContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <h3>Error Generating ICD Codes</h3>
                    <p>${data.error || 'Unknown error occurred'}</p>
                    <button class="btn-secondary" onclick="document.getElementById('icd-results').style.display='none'">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
        }
    })
    .catch(error => {
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'Generate ICD11 Codes <i class="fas fa-code"></i>';
        
        console.error('Error generating ICD11 codes:', error);
        resultsContainer.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <h3>Network Error</h3>
                <p>Error generating ICD11 codes: ${error.message}</p>
                <button class="btn-secondary" onclick="document.getElementById('icd-results').style.display='none'">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        `;
    });
}

function displayICD11Results(icdCodes, analysisNotes) {
    const resultsContainer = document.getElementById('icd-results');
    
    if (!icdCodes || icdCodes.length === 0) {
        resultsContainer.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <h3>No ICD Codes Generated</h3>
                <p>No ICD codes were generated from the clinical summary.</p>
                <button class="btn-secondary" onclick="document.getElementById('icd-results').style.display='none'">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="icd-results-header">
            <h3><i class="fas fa-file-medical-alt"></i> ICD-11 Diagnostic Codes</h3>
            <p class="results-info">Generated ${icdCodes.length} ICD-11 codes based on clinical analysis</p>
        </div>
        
        <div class="icd-codes-container">
    `;
    
    icdCodes.forEach((code, index) => {
        const confidenceClass = getConfidenceClass(code.confidence);
        html += `
            <div class="icd-code-card">
                <div class="code-header">
                    <div class="code-number">${index + 1}</div>
                    <div class="code-info">
                        <div class="icd-code">${code.code}</div>
                        <div class="confidence-badge ${confidenceClass}">
                            <i class="fas fa-chart-line"></i>
                            ${code.confidence}% confidence
                        </div>
                    </div>
                </div>
                <div class="code-content">
                    <h4 class="code-title">${code.title}</h4>
                    <p class="code-description">${code.description}</p>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Add analysis notes if available
    if (analysisNotes && analysisNotes.trim() !== '') {
        html += `
            <div class="analysis-notes">
                <h4><i class="fas fa-lightbulb"></i> Clinical Analysis Notes</h4>
                <p>${analysisNotes}</p>
            </div>
        `;
    }
    
    // Add action buttons
    html += `
        <div class="results-actions">
            <button type="button" class="btn-secondary" onclick="document.getElementById('icd-results').style.display='none'">
                <i class="fas fa-times"></i> Close Results
            </button>
    `;
    
    // Add differential questioning button if more than 2 codes
    if (icdCodes.length > 2) {
        html += `
            <button type="button" class="btn-primary" onclick="startDifferentialQuestioning()" id="start-differential-btn">
                <i class="fas fa-question-circle"></i> Start Differential Questions (${icdCodes.length} → 2 codes)
            </button>
        `;
    } else {
        html += `
            <button type="button" class="btn-primary" onclick="completeAssessment()">
                <i class="fas fa-check"></i> Complete Assessment
            </button>
        `;
    }
    
    html += '</div>';
    
    // Add differential questioning section (initially hidden)
    html += `
        <div id="differential-questioning" class="differential-questioning-section" style="display: none;">
            <div class="differential-header">
                <h4><i class="fas fa-stethoscope"></i> Differential Diagnosis Questions</h4>
                <p>Answer targeted medical questions to narrow down to the 2 most likely ICD codes</p>
                <div class="progress-info">
                    <span id="remaining-count">${icdCodes.length}</span> codes remaining → Target: 2 codes
                </div>
            </div>
            
            <div id="current-question" class="question-container" style="display: none;">
                <div class="question-content">
                    <h5 id="question-text"></h5>
                    <div id="question-reasoning" class="question-reasoning"></div>
                </div>
                
                <div id="answer-options" class="answer-options">
                    <!-- Options will be populated dynamically -->
                </div>
                
                <div class="question-actions">
                    <button type="button" class="btn-primary" onclick="submitAnswer()" id="submit-answer-btn" disabled>
                        <i class="fas fa-paper-plane"></i> Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="elimination-history" class="elimination-history">
                <h5><i class="fas fa-history"></i> Elimination History</h5>
                <div id="elimination-list"></div>
            </div>
        </div>
    `;
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
    
    // Store current codes globally for differential questioning
    window.currentICDCodes = icdCodes;
    
    // Initialize elimination history only if it doesn't exist (don't reset existing history)
    if (!window.eliminationHistory) {
        window.eliminationHistory = [];
        console.log('🔄 Initialized new elimination history');
    } else {
        console.log(`🔄 Preserving existing elimination history: ${window.eliminationHistory.length} entries`);
    }
    
    console.log(`Displayed ${icdCodes.length} ICD codes`);
}

function getConfidenceClass(confidence) {
    if (confidence >= 90) return 'confidence-high';
    if (confidence >= 70) return 'confidence-medium';
    return 'confidence-low';
}

async function checkQuestionsSkippedStatus() {
    try {
        const response = await fetch('/check_questions_skipped_status');
        const data = await response.json();
        return data.questions_skipped || false;
    } catch (error) {
        console.error('Error checking skip status:', error);
        return false; // Default to false if we can't determine
    }
}

function showSkipDisclaimer() {
    return new Promise((resolve) => {
        // Create disclaimer modal
        const overlay = document.createElement('div');
        overlay.className = 'skip-disclaimer-overlay';
        overlay.innerHTML = `
            <div class="skip-disclaimer-modal">
                <div class="disclaimer-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Analysis Disclaimer</h3>
                </div>
                <div class="disclaimer-content">
                    <div class="disclaimer-message">
                        <p><strong>Important Notice:</strong> Follow-up questions in the previous step were skipped.</p>
                        <p>The ICD-11 code analysis will be performed based solely on your initial symptoms and clinical summary. 
                           For improved diagnostic accuracy, it is recommended to complete all follow-up questions.</p>
                        <div class="disclaimer-options">
                            <div class="option-item">
                                <i class="fas fa-arrow-left"></i>
                                <span>Go back to Step 6 to complete follow-up questions</span>
                            </div>
                            <div class="option-item">
                                <i class="fas fa-forward"></i>
                                <span>Continue with current analysis (limited accuracy)</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="disclaimer-actions">
                    <button class="btn-secondary" onclick="goBackToStep6()">
                        <i class="fas fa-arrow-left"></i> Go Back to Step 6
                    </button>
                    <button class="btn-primary" onclick="proceedWithLimitedAnalysis()">
                        Continue Anyway <i class="fas fa-forward"></i>
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Store resolve function globally so button handlers can access it
        window.skipDisclaimerResolve = resolve;
        
        // Add event listener for overlay click (don't close on outside click for this important modal)
    });
}

function goBackToStep6() {
    // Resolve with false to indicate cancellation
    if (window.skipDisclaimerResolve) {
        window.skipDisclaimerResolve(false);
        delete window.skipDisclaimerResolve;
    }
    
    // Close modal and navigate
    const overlay = document.querySelector('.skip-disclaimer-overlay');
    if (overlay) {
        overlay.remove();
    }
    
    window.location.href = '/step6';
}

function proceedWithLimitedAnalysis() {
    // Resolve with true BEFORE closing to avoid cleanup
    if (window.skipDisclaimerResolve) {
        window.skipDisclaimerResolve(true);
        delete window.skipDisclaimerResolve; // Clean up immediately
    }
    
    // Close the modal after resolving
    const overlay = document.querySelector('.skip-disclaimer-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function closeSkipDisclaimer() {
    const overlay = document.querySelector('.skip-disclaimer-overlay');
    if (overlay) {
        overlay.remove();
    }
    // Don't auto-resolve here - let the specific action buttons handle resolution
    if (window.skipDisclaimerResolve) {
        delete window.skipDisclaimerResolve;
    }
}

function completeAssessment() {
    const confirmed = confirm('Are you ready to complete the assessment? This will save your clinical summary and finish the diagnostic process.');
    
    if (confirmed) {
        // Save all step7 data
        saveStep7Data()
            .then(() => {
                showCompletionSection();
                showSuccess('Assessment completed successfully!');
            })
            .catch(error => {
                console.error('Error completing assessment:', error);
                showError('Failed to complete assessment: ' + error.message);
            });
    }
}

function showError(message) {
    // You can implement a more sophisticated error display here
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-error';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    
    // Insert at the top of the container
    const container = document.querySelector('.icd-container');
    container.insertBefore(errorDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'alert alert-success';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    
    // Insert at the top of the container
    const container = document.querySelector('.icd-container');
    container.insertBefore(successDiv, container.firstChild);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.remove();
        }
    }, 3000);
}

// Differential Questioning Functions
let currentQuestion = null;
let selectedAnswer = null;
let questionGenerationAttempts = 0;
let maxQuestionAttempts = 10; // Prevent infinite loops

function startDifferentialQuestioning() {
    console.log('Starting differential questioning...');
    
    // Reset attempt counter
    questionGenerationAttempts = 0;
    
    const questioningSection = document.getElementById('differential-questioning');
    const startBtn = document.getElementById('start-differential-btn');
    
    questioningSection.style.display = 'block';
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    
    // Generate first question
    generateDifferentialQuestion();
}

function generateDifferentialQuestion() {
    console.log('Generating differential question...');
    
    // Increment attempt counter
    questionGenerationAttempts++;
    console.log(`🔢 Question generation attempt: ${questionGenerationAttempts}/${maxQuestionAttempts}`);
    
    // Check if we've exceeded max attempts
    if (questionGenerationAttempts > maxQuestionAttempts) {
        console.error('❌ Max question generation attempts exceeded!');
        showError('Too many attempts to generate questions. Finishing with current codes.');
        finishDifferentialQuestioning();
        return;
    }
    
    if (window.currentICDCodes.length <= 2) {
        console.log('Target reached: 2 or fewer codes remaining');
        finishDifferentialQuestioning();
        return;
    }
    
    const clinicalSummary = document.getElementById('clinical-summary-text').value;
    
    // Get comprehensive patient data summary
    fetch('/get_patient_data_summary')
    .then(response => response.json())
    .then(patientDataResponse => {
        let patientDataSummary = "Basic patient information";
        
        if (patientDataResponse.success) {
            patientDataSummary = patientDataResponse.patient_data_summary;
            console.log('Patient data summary loaded:', patientDataSummary.length, 'characters');
        } else {
            console.warn('Failed to load patient data summary:', patientDataResponse.error);
        }
        
        // Now generate the differential question with full context
        fetch('/generate_differential_question', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                icd_codes: window.currentICDCodes,
                clinical_summary: clinicalSummary,
                patient_data_summary: patientDataSummary,
                elimination_history: window.eliminationHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDifferentialQuestion(data);
            } else {
                console.error('Failed to generate question:', data.error);
                showError('Failed to generate differential question: ' + data.error);
                
                // Re-enable start button on error
                resetDifferentialButton('Failed to generate question');
            }
        })
        .catch(error => {
            console.error('Error generating question:', error);
            showError('Error generating differential question: ' + error.message);
            
            // Re-enable start button on error  
            resetDifferentialButton('Network error occurred');
        });
    })
    .catch(error => {
        console.warn('Error loading patient data summary:', error);
        
        // Proceed without patient data summary
        const patientDataSummary = "Patient data unavailable";
        
        fetch('/generate_differential_question', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                icd_codes: window.currentICDCodes,
                clinical_summary: clinicalSummary,
                patient_data_summary: patientDataSummary,
                elimination_history: window.eliminationHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDifferentialQuestion(data);
            } else {
                console.error('Failed to generate question:', data.error);
                showError('Failed to generate differential question: ' + data.error);
                
                // Re-enable start button on error  
                resetDifferentialButton('Failed to generate question');
            }
        })
        .catch(error => {
            console.error('Error generating question:', error);
            showError('Error generating differential question: ' + error.message);
            
            // Re-enable start button on error  
            resetDifferentialButton('Network error occurred');
        });
    });
}

function displayDifferentialQuestion(questionData) {
    console.log('Displaying differential question:', questionData);
    
    currentQuestion = questionData;
    selectedAnswer = null;
    
    const questionContainer = document.getElementById('current-question');
    const questionText = document.getElementById('question-text');
    const questionReasoning = document.getElementById('question-reasoning');
    const answerOptions = document.getElementById('answer-options');
    const submitBtn = document.getElementById('submit-answer-btn');
    
    questionText.textContent = questionData.question;
    questionReasoning.innerHTML = `<strong>Clinical Focus:</strong> ${questionData.reasoning}`;
    
    // Generate answer options
    let optionsHTML = '';
    questionData.answer_options.forEach((option, index) => {
        const escapedOption = option.replace(/'/g, "\\'");
        optionsHTML += `
            <label class="answer-option">
                <input type="radio" name="differential-answer" value="${option}" onchange="selectAnswer(\`${escapedOption}\`)">
                <span class="option-text">${option}</span>
            </label>
        `;
    });
    
    answerOptions.innerHTML = optionsHTML;
    questionContainer.style.display = 'block';
    submitBtn.disabled = true;
    
    // Update remaining count
    document.getElementById('remaining-count').textContent = window.currentICDCodes.length;
}

function selectAnswer(answer) {
    selectedAnswer = answer;
    document.getElementById('submit-answer-btn').disabled = false;
}

function submitAnswer() {
    if (!selectedAnswer || !currentQuestion) {
        showError('Please select an answer before submitting');
        return;
    }
    
    console.log('Submitting answer:', selectedAnswer);
    
    const submitBtn = document.getElementById('submit-answer-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    const clinicalSummary = document.getElementById('clinical-summary-text').value;
    
    fetch('/process_differential_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            answer: selectedAnswer,
            question: currentQuestion.question,
            icd_codes: window.currentICDCodes,
            target_code_to_eliminate: currentQuestion.target_code_to_eliminate,
            clinical_summary: clinicalSummary
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            processEliminationResult(data);
        } else {
            console.error('Failed to process answer:', data.error);
            showError('Failed to process answer: ' + data.error);
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Answer';
        }
    })
    .catch(error => {
        console.error('Error processing answer:', error);
        showError('Error processing answer: ' + error.message);
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Answer';
    });
}

function processEliminationResult(data) {
    console.log('Processing elimination result:', data);
    
    // Log current state before update
    console.log('🔍 BEFORE elimination:');
    console.log('  - Current codes count:', window.currentICDCodes.length);
    console.log('  - Current codes:', window.currentICDCodes.map(c => c.code));
    
    if (!data.success) {
        console.error('❌ Elimination failed:', data.error);
        showError('Elimination failed: ' + data.error);
        
        // Reset submit button
        const submitBtn = document.getElementById('submit-answer-btn');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Answer';
        return;
    }
    
    // Verify elimination data
    console.log('🔍 Elimination data received:');
    console.log('  - Eliminated code:', data.eliminated_code);
    console.log('  - Updated codes count:', data.updated_icd_codes ? data.updated_icd_codes.length : 'undefined');
    console.log('  - Remaining count:', data.remaining_count);
    
    if (!data.updated_icd_codes || data.updated_icd_codes.length === window.currentICDCodes.length) {
        console.error('❌ No codes were actually eliminated!');
        console.log('  - Original count:', window.currentICDCodes.length);
        console.log('  - Updated count:', data.updated_icd_codes ? data.updated_icd_codes.length : 'undefined');
        
        showError('No codes were eliminated. There may be an issue with the elimination process.');
        
        // Reset submit button
        const submitBtn = document.getElementById('submit-answer-btn');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Answer';
        return;
    }
    
    // Update current codes
    const oldCount = window.currentICDCodes.length;
    window.currentICDCodes = data.updated_icd_codes;
    const newCount = window.currentICDCodes.length;
    
    console.log('🔍 AFTER elimination:');
    console.log('  - Updated codes count:', newCount);
    console.log('  - Updated codes:', window.currentICDCodes.map(c => c.code));
    console.log('  - Count change:', oldCount, '->', newCount);
    
    // Verify count decreased by exactly 1
    if (newCount !== oldCount - 1) {
        console.error('❌ Unexpected count change!', 'Expected:', oldCount - 1, 'Got:', newCount);
        showError(`Unexpected elimination result. Expected ${oldCount - 1} codes, but got ${newCount} codes.`);
    }
    
    // Add to elimination history
    const eliminationEntry = {
        eliminated_code: data.eliminated_code,
        reasoning: data.reasoning,
        question: currentQuestion.question,
        answer: selectedAnswer
    };
    window.eliminationHistory.push(eliminationEntry);
    
    console.log('📝 Added to elimination history:', eliminationEntry);
    console.log('📚 Total elimination history entries:', window.eliminationHistory.length);
    
    // Update elimination history display
    updateEliminationHistory();
    
    // Update remaining count display
    document.getElementById('remaining-count').textContent = newCount;
    
    // Update ICD codes display
    updateICDCodesDisplay();
    
    // Hide current question
    document.getElementById('current-question').style.display = 'none';
    
    // Reset submit button
    const submitBtn = document.getElementById('submit-answer-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Answer';
    
    // Show success message
    showSuccess(`Eliminated: ${data.eliminated_code} - ${data.reasoning}`);
    
    // Continue or finish based on actual count
    console.log('🤔 Deciding next action:');
    console.log('  - Current count:', newCount);
    console.log('  - Target count: 2');
    
    setTimeout(() => {
        if (newCount <= 2) {
            console.log('✅ Target reached! Finishing differential questioning.');
            finishDifferentialQuestioning();
        } else {
            console.log('🔄 Continuing with next question...');
            try {
                generateDifferentialQuestion();
            } catch (error) {
                console.error('❌ Error generating next question:', error);
                resetDifferentialButton('Error generating next question: ' + error.message);
                showError('Error continuing differential questioning: ' + error.message);
            }
        }
    }, 2000);
}

function updateEliminationHistory() {
    const historyContainer = document.getElementById('elimination-list');
    
    let historyHTML = '';
    window.eliminationHistory.forEach((entry, index) => {
        historyHTML += `
            <div class="elimination-entry">
                <div class="elimination-header">
                    <span class="elimination-number">#${index + 1}</span>
                    <span class="eliminated-code">${entry.eliminated_code}</span>
                </div>
                <div class="elimination-details">
                    <div class="question-asked"><strong>Q:</strong> ${entry.question}</div>
                    <div class="answer-given"><strong>A:</strong> ${entry.answer}</div>
                    <div class="reasoning"><strong>Reasoning:</strong> ${entry.reasoning}</div>
                </div>
            </div>
        `;
    });
    
    historyContainer.innerHTML = historyHTML;
}

function updateICDCodesDisplay() {
    // Update the main ICD codes display with remaining codes
    const codesContainer = document.querySelector('.icd-codes-container');
    
    let html = '';
    window.currentICDCodes.forEach((code, index) => {
        const confidenceClass = getConfidenceClass(code.confidence);
        html += `
            <div class="icd-code-card">
                <div class="code-header">
                    <div class="code-number">${index + 1}</div>
                    <div class="code-info">
                        <div class="icd-code">${code.code}</div>
                        <div class="confidence-badge ${confidenceClass}">
                            <i class="fas fa-chart-line"></i>
                            ${code.confidence}% confidence
                        </div>
                    </div>
                </div>
                <div class="code-content">
                    <h4 class="code-title">${code.title}</h4>
                    <p class="code-description">${code.description}</p>
                </div>
            </div>
        `;
    });
    
    codesContainer.innerHTML = html;
}

function finishDifferentialQuestioning() {
    console.log('Finishing differential questioning...');
    
    const questioningSection = document.getElementById('differential-questioning');
    const startBtn = document.getElementById('start-differential-btn');
    
    // Hide questioning section
    document.getElementById('current-question').style.display = 'none';
    
    // Show completion message
    const completionMessage = document.createElement('div');
    completionMessage.className = 'differential-completion';
    completionMessage.innerHTML = `
        <div class="completion-content">
            <i class="fas fa-check-circle fa-2x text-success"></i>
            <h4>Differential Diagnosis Complete!</h4>
            <p>Successfully narrowed down to ${window.currentICDCodes.length} most likely ICD codes.</p>
            <div class="completion-actions">
                <button type="button" class="btn-primary" onclick="generateDiagnosticTests()">
                    <i class="fas fa-flask"></i> Generate Diagnostic Tests
                </button>
                <button type="button" class="btn-secondary" onclick="completeAssessment()">
                    <i class="fas fa-flag-checkered"></i> Complete Assessment
                </button>
            </div>
        </div>
    `;
    
    questioningSection.appendChild(completionMessage);
    
    // Update start button to show completion
    if (startBtn) {
        startBtn.innerHTML = '<i class="fas fa-check"></i> Differential Complete';
        startBtn.disabled = true;
    }
    
    // Show final success message
    showSuccess(`Differential diagnosis complete! Narrowed down to ${window.currentICDCodes.length} codes.`);
}

function resetDifferentialButton(errorMessage) {
    console.log('🔧 Resetting differential button due to:', errorMessage);
    
    const startBtn = document.getElementById('start-differential-btn');
    if (startBtn) {
        const currentCount = window.currentICDCodes ? window.currentICDCodes.length : 0;
        
        if (currentCount > 2) {
            startBtn.disabled = false;
            startBtn.innerHTML = `<i class="fas fa-question-circle"></i> Continue Questions (${currentCount} → 2 codes)`;
        } else {
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-check"></i> Target Reached';
        }
    }
    
    // Also hide any current question display
    const questionContainer = document.getElementById('current-question');
    if (questionContainer) {
        questionContainer.style.display = 'none';
    }
}

// Diagnostic Tests Functions
function generateDiagnosticTests() {
    console.log('🧪 Generating diagnostic tests recommendations...');
    
    if (!window.currentICDCodes || window.currentICDCodes.length === 0) {
        showError('No ICD codes available for diagnostic test generation');
        return;
    }
    
    const clinicalSummary = document.getElementById('clinical-summary-text').value;
    
    // Show loading state
    showDiagnosticTestsLoading();
    
    // Get comprehensive patient data summary first
    fetch('/get_patient_data_summary')
    .then(response => response.json())
    .then(patientDataResponse => {
        let patientDataSummary = "Basic patient information";
        
        if (patientDataResponse.success) {
            patientDataSummary = patientDataResponse.patient_data_summary;
            console.log('Patient data summary loaded for tests:', patientDataSummary.length, 'characters');
        } else {
            console.warn('Failed to load patient data summary for tests:', patientDataResponse.error);
        }
        
        // Generate diagnostic tests with full context
        fetch('/generate_diagnostic_tests', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                icd_codes: window.currentICDCodes,
                clinical_summary: clinicalSummary,
                patient_data_summary: patientDataSummary,
                elimination_history: window.eliminationHistory || []
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDiagnosticTests(data);
            } else {
                console.error('Failed to generate diagnostic tests:', data.error);
                showError('Failed to generate diagnostic tests: ' + data.error);
                hideDiagnosticTestsLoading();
            }
        })
        .catch(error => {
            console.error('Error generating diagnostic tests:', error);
            showError('Error generating diagnostic tests: ' + error.message);
            hideDiagnosticTestsLoading();
        });
    })
    .catch(error => {
        console.warn('Error loading patient data summary for tests:', error);
        
        // Proceed without patient data summary
        fetch('/generate_diagnostic_tests', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                icd_codes: window.currentICDCodes,
                clinical_summary: clinicalSummary,
                patient_data_summary: "Patient data unavailable",
                elimination_history: window.eliminationHistory || []
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDiagnosticTests(data);
            } else {
                console.error('Failed to generate diagnostic tests:', data.error);
                showError('Failed to generate diagnostic tests: ' + data.error);
                hideDiagnosticTestsLoading();
            }
        })
        .catch(error => {
            console.error('Error generating diagnostic tests:', error);
            showError('Error generating diagnostic tests: ' + error.message);
            hideDiagnosticTestsLoading();
        });
    });
}

function showDiagnosticTestsLoading() {
    // Create or get diagnostic tests container
    let testsContainer = document.getElementById('diagnostic-tests-results');
    if (!testsContainer) {
        testsContainer = document.createElement('div');
        testsContainer.id = 'diagnostic-tests-results';
        testsContainer.className = 'diagnostic-tests-section';
        
        // Insert after differential questioning section
        const questioningSection = document.getElementById('differential-questioning');
        questioningSection.parentNode.insertBefore(testsContainer, questioningSection.nextSibling);
    }
    
    testsContainer.innerHTML = `
        <div class="tests-loading-state">
            <div class="loading-spinner">
                <i class="fas fa-flask fa-spin fa-2x"></i>
            </div>
            <h3>Generating Diagnostic Tests Recommendations...</h3>
            <p>Analyzing narrowed ICD codes and generating targeted diagnostic tests...</p>
        </div>
    `;
    testsContainer.style.display = 'block';
}

function hideDiagnosticTestsLoading() {
    const testsContainer = document.getElementById('diagnostic-tests-results');
    if (testsContainer) {
        testsContainer.style.display = 'none';
    }
}

function displayDiagnosticTests(testsData) {
    console.log('📊 Displaying diagnostic tests:', testsData);
    
    // Store diagnostic tests data in global variables for data extraction
    window.currentDiagnosticTests = testsData.diagnostic_tests || [];
    window.currentAnalysisNotes = testsData.analysis_notes || '';
    
    const testsContainer = document.getElementById('diagnostic-tests-results');
    
    if (!testsData.diagnostic_tests || testsData.diagnostic_tests.length === 0) {
        testsContainer.innerHTML = `
            <div class="tests-error-state">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <h3>No Diagnostic Tests Generated</h3>
                <p>No diagnostic tests were generated for the current ICD codes.</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="diagnostic-tests-header">
            <h3><i class="fas fa-flask"></i> Recommended Diagnostic Tests</h3>
            <p class="tests-info">Based on ${window.currentICDCodes.length} narrowed ICD codes from differential diagnosis</p>
        </div>
    `;
    
    // Show priority tests first
    if (testsData.priority_tests && testsData.priority_tests.length > 0) {
        html += `
            <div class="priority-tests-section">
                <h4><i class="fas fa-exclamation-circle text-danger"></i> Priority Tests (Immediate)</h4>
                <div class="priority-tests-list">
        `;
        
        testsData.priority_tests.forEach((test, index) => {
            html += `<span class="priority-test-item">${test}</span>`;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Group tests by category
    const testsByCategory = {};
    testsData.diagnostic_tests.forEach(test => {
        const category = test.category || 'Other';
        if (!testsByCategory[category]) {
            testsByCategory[category] = [];
        }
        testsByCategory[category].push(test);
    });
    
    html += '<div class="diagnostic-tests-container">';
    
    Object.keys(testsByCategory).forEach(category => {
        html += `
            <div class="test-category-section">
                <h4><i class="fas ${getCategoryIcon(category)}"></i> ${category} Tests</h4>
                <div class="tests-in-category">
        `;
        
        testsByCategory[category].forEach((test, index) => {
            const urgencyClass = getUrgencyClass(test.urgency);
            const costClass = getCostClass(test.cost_tier);
            
            html += `
                <div class="diagnostic-test-card">
                    <div class="test-header">
                        <h5 class="test-name">${test.test_name}</h5>
                        <div class="test-badges">
                            <span class="urgency-badge ${urgencyClass}">${test.urgency}</span>
                            <span class="cost-badge ${costClass}">${test.cost_tier} Cost</span>
                        </div>
                    </div>
                    <div class="test-content">
                        <div class="test-reasoning">
                            <strong>Clinical Reasoning:</strong> ${test.reasoning}
                        </div>
                        <div class="expected-findings">
                            <strong>Expected Findings:</strong> ${test.expected_findings}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>';
    });
    
    html += '</div>';
    
    // Add clinical insights
    if (testsData.reasoning) {
        html += `
            <div class="tests-reasoning-section">
                <h4><i class="fas fa-lightbulb"></i> Clinical Strategy</h4>
                <p>${testsData.reasoning}</p>
            </div>
        `;
    }
    
    if (testsData.estimated_timeline) {
        html += `
            <div class="tests-timeline-section">
                <h4><i class="fas fa-clock"></i> Estimated Timeline</h4>
                <p>${testsData.estimated_timeline}</p>
            </div>
        `;
    }
    
    if (testsData.cost_considerations) {
        html += `
            <div class="tests-cost-section">
                <h4><i class="fas fa-dollar-sign"></i> Cost Considerations</h4>
                <p>${testsData.cost_considerations}</p>
            </div>
        `;
    }
    
    if (testsData.clinical_notes) {
        html += `
            <div class="tests-notes-section">
                <h4><i class="fas fa-sticky-note"></i> Clinical Notes</h4>
                <p>${testsData.clinical_notes}</p>
            </div>
        `;
    }
    
    // Add action buttons
    html += `
        <div class="tests-actions">
            <button type="button" class="btn-secondary" onclick="document.getElementById('diagnostic-tests-results').style.display='none'">
                <i class="fas fa-times"></i> Close Tests
            </button>
            <button type="button" class="btn-secondary" onclick="showFeedbackDialog()">
                <i class="fas fa-comment-alt"></i> Feedback
            </button>
            <button type="button" class="btn-primary" onclick="completeAssessment()">
                <i class="fas fa-check"></i> Complete Assessment
            </button>
        </div>
    `;
    
    testsContainer.innerHTML = html;
    testsContainer.style.display = 'block';
    
    console.log(`✅ Displayed ${testsData.diagnostic_tests.length} diagnostic tests`);
    showSuccess('Diagnostic tests recommendations generated successfully!');
}

function getCategoryIcon(category) {
    const icons = {
        'Laboratory': 'fa-vial',
        'Imaging': 'fa-x-ray',
        'Cardiology': 'fa-heartbeat',
        'Pulmonary': 'fa-lungs',
        'Endoscopy': 'fa-search',
        'Biopsy': 'fa-microscope',
        'Other': 'fa-stethoscope'
    };
    return icons[category] || 'fa-stethoscope';
}

function getUrgencyClass(urgency) {
    if (!urgency) return 'urgency-normal';
    const urgencyLower = urgency.toLowerCase();
    if (urgencyLower.includes('immediate') || urgencyLower.includes('stat')) {
        return 'urgency-immediate';
    } else if (urgencyLower.includes('24h') || urgencyLower.includes('urgent')) {
        return 'urgency-urgent';
    } else if (urgencyLower.includes('week')) {
        return 'urgency-week';
    }
    return 'urgency-normal';
}

function getCostClass(costTier) {
    if (!costTier) return 'cost-medium';
    const costLower = costTier.toLowerCase();
    if (costLower.includes('low')) {
        return 'cost-low';
    } else if (costLower.includes('high')) {
        return 'cost-high';
    }
    return 'cost-medium';
}

function showCompletionSection() {
    const completionSection = document.getElementById('completion-section');
    
    // Show completion section
    completionSection.style.display = 'block';
    
    // Scroll to completion section
    completionSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function saveStep7Data() {
    return new Promise((resolve, reject) => {
        // Collect all step7 data including clinical summary and ICD codes
        const clinicalSummary = document.getElementById('clinical-summary-text').value;
        
        // Get ICD results from the page if available
        const icdResults = extractIcdResults();
        
        // Prepare comprehensive step7 data
        const step7Data = {
            clinical_summary: clinicalSummary,
            original_clinical_summary: originalSummary,
            icd_codes: icdResults.codes || [],
            diagnostic_tests: icdResults.tests || [],
            recommendations: icdResults.recommendations || [],
            system_analysis: icdResults.analysis || {},
            completion_timestamp: new Date().toISOString(),
            session_duration: Date.now() - sessionStartTime || 0
        };
        
        console.log('Saving comprehensive step7 data:', step7Data);
        
        fetch('/save_step7_complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(step7Data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Step7 data saved successfully');
                resolve(data);
            } else {
                console.error('❌ Failed to save step7 data:', data.error);
                reject(new Error(data.error));
            }
        })
        .catch(error => {
            console.error('❌ Network error saving step7 data:', error);
            reject(error);
        });
    });
}

function extractIcdResults() {
    const results = {
        codes: [],
        tests: [],
        recommendations: [],
        analysis: {}
    };
    
    try {
        // Extract ICD codes from the results container
        const resultsContainer = document.getElementById('icd-results');
        if (resultsContainer && resultsContainer.style.display !== 'none') {
            // Extract ICD codes from global variable if available
            if (window.currentICDCodes && window.currentICDCodes.length > 0) {
                results.codes = window.currentICDCodes.map(code => ({
                    code: code.code || '',
                    description: code.description || '',
                    confidence: code.confidence || '',
                    category: code.category || '',
                    urgency: code.urgency || ''
                }));
            } else {
                // Fallback: try to extract from DOM
                const codeElements = resultsContainer.querySelectorAll('.icd-code');
                results.codes = Array.from(codeElements).map(el => ({
                    code: el.textContent.trim(),
                    description: el.nextElementSibling?.textContent.trim() || '',
                    confidence: el.closest('.icd-item')?.querySelector('.confidence')?.textContent.trim() || ''
                }));
            }
        }
        
        // Extract diagnostic tests from the diagnostic tests container
        const testsContainer = document.getElementById('diagnostic-tests-results');
        if (testsContainer && testsContainer.style.display !== 'none') {
            // Extract from global variable if available
            if (window.currentDiagnosticTests && window.currentDiagnosticTests.length > 0) {
                results.tests = window.currentDiagnosticTests.map(test => ({
                    test_name: test.test_name || '',
                    category: test.category || '',
                    rationale: test.rationale || '',
                    urgency: test.urgency || '',
                    expected_findings: test.expected_findings || '',
                    cost_estimate: test.cost_estimate || '',
                    preparation_required: test.preparation_required || false
                }));
            } else {
                // Fallback: try to extract from DOM
                const testElements = testsContainer.querySelectorAll('.test-item');
                results.tests = Array.from(testElements).map(el => ({
                    test_name: el.querySelector('.test-name')?.textContent.trim() || '',
                    category: el.querySelector('.test-category')?.textContent.trim() || '',
                    rationale: el.querySelector('.test-rationale')?.textContent.trim() || '',
                    urgency: el.querySelector('.test-urgency')?.textContent.trim() || ''
                }));
            }
        }
        
        // Extract any clinical recommendations or analysis notes
        if (window.currentAnalysisNotes) {
            results.analysis = {
                clinical_notes: window.currentAnalysisNotes,
                generated_timestamp: new Date().toISOString()
            };
        }
        
    } catch (error) {
        console.warn('Could not extract all ICD results:', error);
    }
    
    console.log('Extracted results for saving:', results);
    return results;
}

function downloadReport() {
    // Implementation for downloading the complete medical report
    window.location.href = '/download_report';
}

function startNewAssessment() {
    // Clear session and start fresh
    if (confirm('Are you sure you want to start a new assessment? This will clear all current data.')) {
        window.location.href = '/step1';
    }
}

// Track session start time for duration calculation
const sessionStartTime = Date.now();

// Modify the existing generateICD11Codes function to show feedback after completion
const originalGenerateICD11Codes = generateICD11Codes;
if (typeof generateICD11Codes === 'function') {
    generateICD11Codes = function() {
        // Call the original function
        const result = originalGenerateICD11Codes.apply(this, arguments);
        
        return result;
    };
} else {
    // If the function doesn't exist yet, we'll create a wrapper
    function generateICD11Codes() {
        console.log('Generating ICD11 codes...');
        // Your existing ICD generation code would go here
    }
}

// Feedback Modal Functions
function showFeedbackDialog() {
    const modal = document.getElementById('feedback-modal');
    const textarea = document.getElementById('feedback-text');
    
    if (modal && textarea) {
        modal.style.display = 'flex';
        textarea.focus();
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }
}

function closeFeedbackDialog() {
    const modal = document.getElementById('feedback-modal');
    const textarea = document.getElementById('feedback-text');
    
    if (modal) {
        modal.style.display = 'none';
        // Restore body scroll
        document.body.style.overflow = 'auto';
        
        // Clear textarea
        if (textarea) {
            textarea.value = '';
        }
        
        // Clear selected images
        clearImages();
    }
}

function saveFeedback() {
    const textarea = document.getElementById('feedback-text');
    const feedbackText = textarea ? textarea.value.trim() : '';
    
    if (!feedbackText) {
        alert('Please enter your feedback before saving.');
        return;
    }
    
    // Show loading state
    const saveButton = event.target;
    const originalText = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    // Create FormData to handle both text and images
    const formData = new FormData();
    formData.append('feedback', feedbackText);
    formData.append('timestamp', new Date().toISOString());
    formData.append('session_id', '{{ session.get("patient_id", "unknown") }}');
    
    // Add images to FormData
    selectedImages.forEach((image, index) => {
        formData.append(`image_${index}`, image);
    });
    formData.append('image_count', selectedImages.length);
    
    // Save feedback with images to server
    fetch('/save_feedback_with_images', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const imageMsg = selectedImages.length > 0 ? 
                ` and ${selectedImages.length} image${selectedImages.length !== 1 ? 's' : ''}` : '';
            alert(`Thank you for your feedback${imageMsg}! Everything has been saved successfully.`);
            
            // Clear images and close dialog
            clearImages();
            closeFeedbackDialog();
        } else {
            alert('Error saving feedback: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving feedback:', error);
        alert('Error saving feedback. Please try again.');
    })
    .finally(() => {
        // Restore button state
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
    });
}

// Image Upload Handling Functions
let selectedImages = [];

function handleImageSelection(input) {
    const files = Array.from(input.files);
    const previewContainer = document.getElementById('image-preview-container');
    const previewsDiv = document.getElementById('image-previews');
    const imageCount = document.getElementById('image-count');
    
    // Add new images to the array
    files.forEach(file => {
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert(`Image ${file.name} is too large. Maximum size is 10MB.`);
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            alert(`${file.name} is not a valid image file.`);
            return;
        }
        
        selectedImages.push(file);
    });
    
    updateImagePreviews();
    
    // Show preview container if images are selected
    if (selectedImages.length > 0) {
        previewContainer.style.display = 'block';
    }
}

function updateImagePreviews() {
    const previewsDiv = document.getElementById('image-previews');
    const imageCount = document.getElementById('image-count');
    
    previewsDiv.innerHTML = '';
    
    selectedImages.forEach((file, index) => {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview';
        
        const img = document.createElement('img');
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = () => removeImage(index);
        
        previewDiv.appendChild(img);
        previewDiv.appendChild(removeBtn);
        previewsDiv.appendChild(previewDiv);
    });
    
    imageCount.textContent = `${selectedImages.length} image${selectedImages.length !== 1 ? 's' : ''} selected`;
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    updateImagePreviews();
    
    const previewContainer = document.getElementById('image-preview-container');
    if (selectedImages.length === 0) {
        previewContainer.style.display = 'none';
    }
}

function clearImages() {
    selectedImages = [];
    const previewContainer = document.getElementById('image-preview-container');
    const fileInput = document.getElementById('feedback-images');
    
    previewContainer.style.display = 'none';
    fileInput.value = '';
}
</script>

<style>
/* Scrollable Modal Styles */
.feedback-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    z-index: 1000;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1001;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    margin: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 1002;
}

.modal-header {
    padding: 20px 25px 15px;
    border-bottom: 1px solid #e0e0e0;
    flex-shrink: 0;
}

.modal-body {
    padding: 20px 25px;
    overflow-y: auto;
    flex-grow: 1;
    max-height: calc(90vh - 140px); /* Adjust based on header and footer height */
}

.modal-footer {
    padding: 15px 25px 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-shrink: 0;
    background: white;
    border-radius: 0 0 12px 12px;
}

/* Ensure modal is responsive */
@media (max-width: 768px) {
    .modal-overlay {
        padding: 10px;
    }
    
    .modal-content {
        max-height: 95vh;
    }
    
    .modal-body {
        max-height: calc(95vh - 120px);
        padding: 15px 20px;
    }
    
    .modal-header,
    .modal-footer {
        padding: 15px 20px;
    }
}

/* Image Upload Styles */
.image-upload-section {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
}

.image-upload-section .form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    display: block;
}

.upload-description {
    color: #7f8c8d;
    font-size: 14px;
    margin-bottom: 15px;
}

.image-upload-container {
    margin-bottom: 20px;
}

.upload-button {
    display: inline-block;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    font-size: 14px;
    font-weight: 500;
}

.upload-button:hover {
    background: linear-gradient(135deg, #2980b9, #1abc9c);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.upload-info {
    display: block;
    font-size: 12px;
    color: #95a5a6;
    margin-top: 8px;
}

.image-preview-container {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.image-preview-container h4 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 16px;
}

.image-previews {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.image-preview {
    position: relative;
    width: 100px;
    height: 100px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    background: white;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-preview .remove-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-preview .remove-btn:hover {
    background: #c0392b;
}

.image-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.image-count {
    color: #7f8c8d;
    font-size: 14px;
    font-weight: 500;
}

.btn-secondary.small {
    padding: 6px 12px;
    font-size: 12px;
}

/* Skip Disclaimer Modal Styles */
.skip-disclaimer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
    box-sizing: border-box;
}

.skip-disclaimer-modal {
    background: white;
    border-radius: 15px;
    width: 100%;
    max-width: 600px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    animation: modalSlideIn 0.4s ease-out;
}

@keyframes modalSlideIn {
    0% {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.disclaimer-header {
    padding: 25px 30px 20px;
    border-bottom: 2px solid #e0e0e0;
    text-align: center;
}

.disclaimer-header h3 {
    margin: 0;
    color: #e67e22;
    font-size: 1.5em;
    font-weight: 600;
}

.disclaimer-header i {
    margin-right: 10px;
    font-size: 1.2em;
}

.disclaimer-content {
    padding: 25px 30px;
    flex-grow: 1;
    overflow-y: auto;
}

.disclaimer-message {
    text-align: left;
}

.disclaimer-message p {
    margin: 15px 0;
    line-height: 1.6;
    color: #2c3e50;
}

.disclaimer-message p:first-child {
    font-weight: 600;
    color: #e67e22;
    font-size: 1.1em;
}

.disclaimer-options {
    margin: 25px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #e67e22;
}

.option-item {
    display: flex;
    align-items: flex-start;
    margin: 15px 0;
    color: #2c3e50;
}

.option-item i {
    margin-right: 12px;
    margin-top: 2px;
    color: #e67e22;
    font-size: 1.1em;
}

.option-item span {
    flex: 1;
    line-height: 1.4;
}

.disclaimer-actions {
    padding: 20px 30px 25px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 15px;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 0 0 15px 15px;
}

.disclaimer-actions button {
    flex: 1;
    max-width: 200px;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .skip-disclaimer-overlay {
        padding: 15px;
    }
    
    .skip-disclaimer-modal {
        max-height: 90vh;
    }
    
    .disclaimer-header,
    .disclaimer-content,
    .disclaimer-actions {
        padding-left: 20px;
        padding-right: 20px;
    }
    
    .disclaimer-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .disclaimer-actions button {
        max-width: none;
    }
}
</style>
{% endblock %}
